<html>
	<head>
		<title>主页</title>
		<meta http-equiv=Content-Type content="text/html; charset=utf-8">
		<meta content="MSHTML 6.00.2600.0" name=GENERATOR>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
		 crossorigin="anonymous">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
		 crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
		 crossorigin="anonymous"></script>
		<script type="text/javascript" src="webuploader/webuploader.min.js"></script>
		<link rel="stylesheet" href="css/upload.css" />
		<script type="text/javascript" src="js/upload.js"></script>
		<link rel="stylesheet" href="webuploader/webuploader.css" />
		<script type="text/javascript" src="js/jqthumb.js"></script>
		<link rel="stylesheet" href="css/box.css" />
		<script src="js/template.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

	</head>
	<body style="background-color: beige;">
		<div class="container">
			<nav class="navbar navbar-expand-lg navbar-light bg-light">
				<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01"
				 aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarTogglerDemo01">
					<a class="navbar-brand" href="#">Hidden brand</a>
					<ul class="navbar-nav mr-auto mt-2 mt-lg-0">
						<li class="nav-item active">
							<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#">Link</a>
						</li>
						<li class="nav-item">
							<a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
						</li>
					</ul>
					<form class="form-inline my-2 my-lg-0" style="position: relative; right: 20px;">
						<input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
						<button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
					</form>
					<!-- Example single danger button -->
					<div class="btn-group">
						<img id="profile_face" src="images/default.png" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
						 class="img-circle" height="40px" style="border-radius:50%;cursor: pointer;" />
						<div class="dropdown-menu">
							<a class="dropdown-item" href="#">Action</a>
							<a class="dropdown-item" href="#">Another action</a>
							<a class="dropdown-item" href="#">Something else here</a>
							<div class="dropdown-divider"></div>
							<a class="dropdown-item" href="#">Separated link</a>
						</div>
					</div>
				</div>
			</nav>
			<div class="row">
				<div class="col-3">
					&nbsp
					<div class="card">
						<div style="background: #76B852; height: 100px;">
							<img id="profile_face1" src="images/default.png" alt="..." class="img-thumbnail" height="80px" width="80px"
							 style="border-radius:50%;position: relative; top: 60px; left: 20px;">
						</div>
						<div class="card-body">
							<a style="position: relative;left: 90px; top: -20px;">
								<p id="profile_username"></p>
							</a>
							<ul class="list-group">
								<li class="list-group-item d-flex justify-content-between align-items-center">
									微博
									<span id="profile_weiboCount" class="badge badge-primary badge-pill">14</span>
								</li>
								<li class="list-group-item d-flex justify-content-between align-items-center">
									关注
									<span id="profile_followCount" class="badge badge-primary badge-pill">2</span>
								</li>
								<li class="list-group-item d-flex justify-content-between align-items-center">
									粉丝
									<span id="profile_fansCount" class="badge badge-primary badge-pill">1</span>
								</li>
							</ul>
						</div>
					</div>
				</div>
				<div class="col-6">
					&nbsp
					<div class="card gedf-card">
						<div class="card-header">
							<ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
								<li class="nav-item">
									<a class="nav-link active" id="posts-tab" data-toggle="tab" href="#posts" role="tab" aria-controls="posts"
									 aria-selected="true">Make
										a publication</a>
								</li>
							</ul>
						</div>
						<div class="card-body">
							<div class="tab-content" id="myTabContent">
								<div class="tab-pane fade show active" id="posts" role="tabpanel" aria-labelledby="posts-tab">
									<div class="form-group">
										<label class="sr-only" for="message">post</label>
										<textarea class="form-control" id="message" rows="3" placeholder="What are you thinking?"></textarea>
									</div>
								</div>
							</div>
							<div id="uploader-demo">
								<div class="webuploader-container">
									<div id="fileList" class="uploader-list"></div>
									<div id="one" style="float: left; margin-left: 40%;">
										<input type="file" name="file" multiple="multiple" formenctype="multipart/form-data" accept="image/*" style="display: none;">
										<label style="cursor: pointer; background: rgb(255, 255, 255);"></label>
									</div>
								</div>
							</div>
							<div class="btn-toolbar">
								<div class="btn-group">
									<button type="button" class="btn btn-primary" id="filePicker">选图</button>
									<button type="submit" class="btn btn-primary" id="btn_post" onclick="postWeibo()">share</button>
								</div>
							</div>
						</div>
					</div>
					<div id="weiboDiv">
					</div>
					<nav aria-label="Page navigation example">
						<ul class="pagination">
							<li class="page-item">
								<a class="page-link" href="#" aria-label="Previous">
									<span aria-hidden="true">&laquo;</span>
								</a>
							</li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(1)">1</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(2)">2</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(3)">3</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(4)">4</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(5)">5</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(6)">6</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(7)">7</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(8)">8</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(9)">9</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(10)">10</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(11)">11</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(12)">12</a></li>
							<li class="page-item"><a class="page-link" onclick="getWeibo(13)">13</a></li>
							<li class="page-item">
								<a class="page-link" href="#" aria-label="Next">
									<span aria-hidden="true">&raquo;</span>
								</a>
							</li>
						</ul>
					</nav>
					<div class="modal fade" id="weiboModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
					 aria-hidden="true">
						<div class="modal-dialog" role="document">
							<div class="modal-content">
								<div class="modal-header" id="modal_header">
								</div>
								<div class="modal-body" id="modal_body">
									<div class="row">
										<div class="col">
											<span id="commentTo"></span>
											<textarea id="text_comment" class="form-control" rows="1" placeholder="发表评论?"></textarea>
										</div>
									</div>
									<div class="row">
										<div class="col-9"></div>
										<div class="col-3" style="margin-right: 0px;"><button onclick="postComment()" id="btn_comment" type="button"
											 class="btn btn-primary" style="margin-top: 10px;float: right">发表</button></div>
									</div>
								</div>
								<div class="modal-body" id="modal_footer">
								</div>
							</div>
						</div>
					</div>
					<!-- Button trigger modal -->

					<!-- Modal -->
					<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
					 aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="exampleModalCenterTitle">Modal title</h5>
									<button type="button" class="close" data-dismiss="modal" aria-label="Close">
										<span aria-hidden="true">&times;</span>
									</button>
								</div>
								<div class="modal-body">
									...
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
									<button type="button" class="btn btn-primary">Save changes</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-3">
					&nbsp
				</div>
			</div>
		</div>
	</body>
	<script>
		$('#weiboModal').on('show.bs.modal', function (event) {
		var button = $(event.relatedTarget)
		var recipient = 'weiboCard'+button.data('whatever')
		console.log($('#'+recipient)[0].innerHTML);
		document.getElementById('modal_header').innerHTML = $('#'+recipient)[0].innerHTML;
		var weiboId = $('#modal_header').find('.row').first().attr('id');
		weiboId = weiboId.substring(8);
		queryComment(weiboId);
		});	
	</script>
	<script>
		loadPage();
		
		function getCookie(cname) {
			var name = cname + "=";
			var ca = document.cookie.split(';');
			for (var i = 0; i < ca.length; i++) {
				var c = ca[i].trim();
				if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
			}
			return "";
		}
		
		function loadPage(){
			var userInfo = getCookie('userInfo');
			userInfo = JSON.parse(userInfo);
			$('#profile_face').attr('src', '/imgUpload/' + userInfo.face);
			$('#profile_face1').attr('src', '/imgUpload/' + userInfo.face);
			$('#profile_username').text(userInfo.username);
			$('#profile_weiboCount').text(userInfo.weiboCount);
			$('#profile_followCount').text(userInfo.followCount);
			$('#profile_fansCount').text(userInfo.fansCount);
		}
		
		
		function queryComment(weiboId){
			var data = {};
			data.weiboId = weiboId;
			var token = getCookie('token');
			var headers = { Accept:"application/json; charset=utf-8",Authorization:token};
			var queryCommentxhr = $.ajax({
				url:'comment',
				dataType: 'json',
				data:data,
				method:'GET',
				headers:headers,
				success:successCall,
				error:errorCall});
			function successCall(responseResult){
				if(responseResult.code == 1){
					var payload = {}
					payload.list = responseResult.data;
					var html = template(document.getElementById('commentList').innerHTML,payload);
					document.getElementById('modal_footer').innerHTML = html;
				}else{
					alert(responseResult.msg);
				}

			}
			function errorCall(error){
				console.log(error);
			}
		}
		
		function postComment(){
			var content = $('#text_comment').val();
			var commentVo = {};
			commentVo.commentContent = content;
			var weiboId = $('#modal_header').find('.row').first().attr('id');
			weiboId = weiboId.substring(8);
			commentVo.weiboId = weiboId;
			
			var token = getCookie('token');
			var headers = { Accept:"application/json; charset=utf-8",Authorization:token};
			
			var postCommentxhr = $.ajax({
				url:'comment',
				dataType: 'json',
				data:commentVo,
				method:'POST',
				headers:headers,
				success:successCall,
				error:errorCall});
			function successCall(responseResult){
				if(responseResult.code == 1){
					$('#text_comment').val('');
					queryComment(weiboId);
				}else{
					alert(responseResult.msg);
				}
			}
			function errorCall(error){
				console.log(error);
			}
		}
		
		function freshInfo() {
			var token = getCookie('token');
			var data = {}
			var headers = { Accept:"application/json; charset=utf-8",Authorization:token};
			var postWeiboxhr = $.ajax({
				url:'users/fresh',
				dataType: 'json',
				method:'POST',
				data:data,
				headers:headers,
				success:successCall,
				error:errorCall});
			function successCall(responseResult){
				if (responseResult.code == 1) {
					document.cookie = "userInfo = "+ JSON.stringify(responseResult.data);
					document.cookie = "token = "+responseResult.token;
					loadPage();
				}
			}
			function errorCall(error){
				console.log(error);
			}
		
		}
		
		
		
		function postWeibo() {
			var content = $('#message').val();
			var pics = $('div.uploader-list input');
			var arr = pics.map(function() {
				return this;
			}).get();


			var data = {};
			data.content = content;
			for (var i = 0; i < arr.length; i++) {
				var d = i + 1;
				data['pic' + d] = arr[i].value;
			}
			console.log(data);
			
			var token = getCookie('token');
			var headers = { Accept:"application/json; charset=utf-8",Authorization:token};
			
			var postWeiboxhr = $.ajax({
				url:'weibo/post',
				dataType: 'json',
				data:data,
				method:'POST',
				headers:headers,
				success:successCall,
				error:errorCall});
				
			function successCall(responseResult){
				if (responseResult.code == 1) {
					console.log('sucess' + data);
					$('#message').val('');
					var liList = $('div.uploader-list li');
					var liArr = liList.map(function() {
						return this;
					}).get();
					for (var i = 0; i < liArr.length; i++) {
						liArr[i].remove();
					}
					getWeibo(1);
					freshInfo();
				}
			}
			
			function errorCall(error){
				console.log(error);
			}

		}

		function getWeibo(page) {
			var data = {};
			data.pageNum = page;
			data.pageSize = 10;
			var token = getCookie('token');
			var headers = { Accept:"application/json; charset=utf-8",Authorization:token};
			
			var queryWeiboxhr = $.ajax({
				url:'weibo/timeline',
				dataType: 'json',
				data:data,
				method:'GET',
				headers:headers,
				success:successCall,
				error:errorCall});
							
			function successCall(responseResult){
				console.log('成功, 收到的数据: '+responseResult);
				if(responseResult.code == 1){
					var result = responseResult.data;
					console.log(result);
					var payload = {};
					for(var i=0;i<result.length;i++){
						result[i].user.face = '/imgUpload/'+result[i].user.face;
						for(var q=0;q<9;q++){
							if(result[i]['pic'+q]!==null){
								var z =q+1;
								result[i]['pic'+z] = '/imgUpload/'+result[i]['pic'+z]; 
							}
						}
					}
					payload.list = result;
					var html = template(document.getElementById('weiList').innerHTML,payload);
					document.getElementById('weiboDiv').innerHTML = html;
				}
			}
			function errorCall(error){
				console.log('请求出错'+JSON.stringify(error));
			}
		}
		
		getWeibo(1);
		
		
	
	</script>


	<script id="weiList" type="text/html">
		<%for(var i = 0; i < list.length; i++) {%>
								<div class="card">
				<div class="card-body" style="padding:10px;" id=<%:='weiboCard'+list[i].weiboId%> >
					<div class="row" id=<%:='weiboRow'+list[i].weiboId%>  >
						<div class="col-1" style="padding-right: 0px;">
							<img src="<%:=list[i].user.face%>" alt="..." class="img-circles" height="48px" width="48px" style="border-radius:50%" />
						</div>
						<div class="col-11" style="padding-left: 30px;">
							<div class="row align-items-start" style="margin-right: 0px;" data-toggle="modal" data-whatever=<%:=list[i].weiboId%> data-target="#weiboModal">
								<div class="col" style="position: relative;left: 0px;">
									<a href=<%:='profile.html?userid/'+list[i].user.userId%> target="_blank" style="position: relative;left: 0px;"><%:=list[i].user.username%></a>
									<span><%:=list[i].date%></span>
								</div>
								<div class="col" style="margin: 0px; padding: 0px;">
									<div class="btn-group" style="float: right;">
										<button type="button" class="btn dropdown-toggle dropdown-toggle-split" data-toggle="dropdown"
										 aria-haspopup="true" aria-expanded="false">
											<span class="sr-only">Toggle Dropdown</span>
										</button>
										<div class="dropdown-menu">
											<a class="dropdown-item" href="#">Action</a>
											<a class="dropdown-item" href="#">Another action</a>
											<a class="dropdown-item" href="#">Something else here</a>
											<div class="dropdown-divider"></div>
											<a class="dropdown-item" href="#">Separated link</a>
										</div>
									</div>
								</div>
							</div>
							<div class="row align-items-center">
								<div class="col-11">
									<span><%:=list[i].content%></span>
								</div>
							</div>
							<div class="row align-items-center" style="padding-top: 20px;">
								<div class="col-10">
									<%if(list[i].imgCount == 1){%>
										<img class="img-fluid" src=<%:=list[i].pic1%> />
									<%}%>
									<%if(list[i].imgCount == 2){%>
									<div class="row">
										<div class="col">										
											<img class="img-fluid" src=<%:=list[i].pic1%> />
										</div>
										<div class="col">
											<img class="img-fluid" src=<%:=list[i].pic2%> />
										</div>
									</div>
									<%}%>
									<%if(list[i].imgCount == 3){%>
									<div class="row">
										<div class="col-8">										
											<img class="img-fluid" src=<%:=list[i].pic1%> />
										</div>
										<div class="col-4">
											<img class="img-fluid" src=<%:=list[i].pic2%> />
											<img class="img-fluid" src=<%:=list[i].pic3%> />
										</div>
									</div>
									<%}%>
									<%if(list[i].imgCount == 4){%>
									<div class="row">
										<div class="col">										
											<img class="img-fluid" src=<%:=list[i].pic1%> />
											<img class="img-fluid" src=<%:=list[i].pic3%> />
										</div>
										<div class="col">
											<img class="img-fluid" src=<%:=list[i].pic2%> />
											<img class="img-fluid" src=<%:=list[i].pic4%> />
										</div>
									</div>
									<%}%>
								</div>
							</div>
			
							<div class="row align-items-end" style="margin-top: 20px;">
								<div class="col-2">
									<i class="fa fa-comment-o"></i>
									<span id="commentNum"></span>
								</div>
								<div class="col-2">
									<i class="fa fa-clone" ></i>
									<span id="repostNum"></span>
								</div>
								<div class="col-2">
									<i class="fa fa-heart-o"></i>
									<span id="likeNum"></span>
								</div>
								<div class="col-2">
									<i class="fa fa-bookmark-o"></i>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<%}%>
	</script>

	<script type="text/html" id="commentList">
		<%for(var i = 0; i < list.length; i++) {%>
		<div class=" card">
		<div class="card-body">
		<div class="row">
			<div class="col-2">
					<img src=<%:='/imgUpload/'+list[i].user.face%> alt="..." class="img-circles" height="48px" width="48px" style="border-radius:50%" />
			</div>
			<div class="col-8">
				<div class="row">
					<div class="col-4"><%:=list[i].user.username%></div>
					<div class="col-8"><%:=list[i].time%></div>
				</div>
				<div class="row">
					<div class="col">
							<%:=list[i].commentContent%>
					</div>
				</div>
				<div class="row" style="margin-top: 15px;">
					<div class="col-2">
						<i class="fa fa-comment-o" data-toggle="modal" data-target="#exampleModalCenter"></i>
						<span id="commentNum"></span>
					</div>
					<div class="col-2">
						<i class="fa fa-clone" ></i>
						<span id="repostNum"></span>
					</div>
					<div class="col-2">
						<i class="fa fa-heart-o"></i>
						<span id="likeNum"></span>
					</div>
				</div>
			</div>
		</div>
		</div>
		</div>
		<%}%>
	</script>
</html>
